name: Build & Deploy WordPress (ECR + ASG Refresh)

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "wp-content/**"
  workflow_dispatch: {}

env:
  AWS_REGION: eu-west-1
  AWS_DEFAULT_REGION: eu-west-1
  ECR_REPO: 597765856364.dkr.ecr.eu-west-1.amazonaws.com/custom-wordpress
  ECR_REGISTRY: 597765856364.dkr.ecr.eu-west-1.amazonaws.com
  IMAGE_TAG: latest
  ASG_NAME: wp-asg

jobs:
  build_push_refresh:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          set -euxo pipefail
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

      - name: Build image
        run: |
          set -euxo pipefail
          docker build -t custom-wordpress:${IMAGE_TAG} .

      - name: Tag & Push image to ECR
        run: |
          set -euxo pipefail
          docker tag custom-wordpress:${IMAGE_TAG} ${ECR_REPO}:${IMAGE_TAG}
          docker push ${ECR_REPO}:${IMAGE_TAG}

      - name: Start ASG Instance Refresh
        id: start_refresh
        run: |
          set -euxo pipefail
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "${ASG_NAME}" \
            --preferences MinHealthyPercentage=50,InstanceWarmup=180 \
            --region "${AWS_REGION}" \
            --query "InstanceRefreshId" --output text)
          echo "refresh_id=${REFRESH_ID}" >> $GITHUB_OUTPUT
          echo "Started Instance Refresh: ${REFRESH_ID}"

      - name: Wait for Instance Refresh to complete
        run: |
          set -euo pipefail
          REFRESH_ID="${{ steps.start_refresh.outputs.refresh_id }}"
          echo "Waiting for Instance Refresh: ${REFRESH_ID}"

          # timeout 30 минут: 120 * 15s
          for i in $(seq 1 120); do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "${ASG_NAME}" \
              --instance-refresh-ids "${REFRESH_ID}" \
              --region "${AWS_REGION}" \
              --query "InstanceRefreshes[0].Status" --output text)

            REASON=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "${ASG_NAME}" \
              --instance-refresh-ids "${REFRESH_ID}" \
              --region "${AWS_REGION}" \
              --query "InstanceRefreshes[0].StatusReason" --output text)

            echo "[$i/120] Status=${STATUS} Reason=${REASON}"

            if [ "${STATUS}" = "Successful" ]; then
              echo "Instance Refresh completed successfully."
              exit 0
            fi

            if [ "${STATUS}" = "Failed" ] || [ "${STATUS}" = "Cancelled" ]; then
              echo "Instance Refresh did not complete: ${STATUS} (${REASON})"
              exit 1
            fi

            sleep 15
          done

          echo "Timeout waiting for Instance Refresh to complete."
          exit 1
