name: Deploy WordPress (latest -> stable, keep previous, refresh)

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "wp-content/**"
  workflow_dispatch: {}

env:
  AWS_REGION: eu-west-1
  AWS_DEFAULT_REGION: eu-west-1
  ECR_REPO_NAME: custom-wordpress
  ECR_REPO: 597765856364.dkr.ecr.eu-west-1.amazonaws.com/custom-wordpress
  ECR_REGISTRY: 597765856364.dkr.ecr.eu-west-1.amazonaws.com
  ASG_NAME: wp-asg
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          set -euxo pipefail
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

      - name: Build image (local latest)
        run: |
          set -euxo pipefail
          docker build -t custom-wordpress:${IMAGE_TAG} .

      - name: Push image to ECR (:latest)
        run: |
          set -euxo pipefail
          docker tag custom-wordpress:${IMAGE_TAG} ${ECR_REPO}:${IMAGE_TAG}
          docker push ${ECR_REPO}:${IMAGE_TAG}

      - name: Save current stable -> previous (idempotent)
        run: |
          set -euo pipefail

          STABLE_DIGEST=$(aws ecr describe-images \
            --repository-name "${ECR_REPO_NAME}" \
            --image-ids imageTag=stable \
            --region "${AWS_REGION}" \
            --query 'imageDetails[0].imageDigest' \
            --output text 2>/dev/null || true)

          if [ -z "$STABLE_DIGEST" ] || [ "$STABLE_DIGEST" = "None" ]; then
            echo "No stable tag found yet. Skipping previous."
            exit 0
          fi

          PREV_DIGEST=$(aws ecr describe-images \
            --repository-name "${ECR_REPO_NAME}" \
            --image-ids imageTag=previous \
            --region "${AWS_REGION}" \
            --query 'imageDetails[0].imageDigest' \
            --output text 2>/dev/null || true)

          if [ "$PREV_DIGEST" = "$STABLE_DIGEST" ]; then
            echo "previous already equals stable ($STABLE_DIGEST). Skipping."
            exit 0
          fi

          MANIFEST=$(aws ecr batch-get-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-ids imageTag="stable" \
            --region "${AWS_REGION}" \
            --query 'images[0].imageManifest' \
            --output text)

          aws ecr put-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-tag "previous" \
            --image-manifest "$MANIFEST" \
            --region "${AWS_REGION}"

          echo "Saved stable -> previous"

      - name: Promote latest -> stable
        run: |
          set -euxo pipefail

          NEW_MANIFEST=$(aws ecr batch-get-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-ids imageTag="latest" \
            --region "${AWS_REGION}" \
            --query 'images[0].imageManifest' \
            --output text)

          aws ecr put-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-tag "stable" \
            --image-manifest "$NEW_MANIFEST" \
            --region "${AWS_REGION}"

          echo "Promoted latest -> stable"

      - name: Start ASG Instance Refresh
        id: start_refresh
        run: |
          set -euxo pipefail
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "${ASG_NAME}" \
            --preferences MinHealthyPercentage=50,InstanceWarmup=180 \
            --region "${AWS_REGION}" \
            --query "InstanceRefreshId" --output text)
          echo "refresh_id=${REFRESH_ID}" >> $GITHUB_OUTPUT
          echo "Started Instance Refresh: ${REFRESH_ID}"

      - name: Wait for Instance Refresh to complete
        run: |
          set -euo pipefail
          REFRESH_ID="${{ steps.start_refresh.outputs.refresh_id }}"
          echo "Waiting for Instance Refresh: ${REFRESH_ID}"

          for i in $(seq 1 120); do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "${ASG_NAME}" \
              --instance-refresh-ids "${REFRESH_ID}" \
              --region "${AWS_REGION}" \
              --query "InstanceRefreshes[0].Status" --output text)

            REASON=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "${ASG_NAME}" \
              --instance-refresh-ids "${REFRESH_ID}" \
              --region "${AWS_REGION}" \
              --query "InstanceRefreshes[0].StatusReason" --output text)

            echo "[$i/120] Status=${STATUS} Reason=${REASON}"

            if [ "${STATUS}" = "Successful" ]; then
              echo "Refresh completed successfully."
              exit 0
            fi

            if [ "${STATUS}" = "Failed" ] || [ "${STATUS}" = "Cancelled" ]; then
              echo "Refresh did not complete: ${STATUS} (${REASON})"
              exit 1
            fi

            sleep 15
          done

          echo "Timeout waiting for refresh."
          exit 1
