name: Deploy WordPress (latest -> stable, keep previous)

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "wp-content/**"
  workflow_dispatch: {}

env:
  AWS_REGION: eu-west-1
  AWS_DEFAULT_REGION: eu-west-1
  ECR_REPO_NAME: custom-wordpress
  ECR_REPO: 597765856364.dkr.ecr.eu-west-1.amazonaws.com/custom-wordpress
  ECR_REGISTRY: 597765856364.dkr.ecr.eu-west-1.amazonaws.com
  ASG_NAME: wp-asg
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          set -euxo pipefail
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

      - name: Build image (local latest)
        run: |
          set -euxo pipefail
          docker build -t custom-wordpress:${IMAGE_TAG} .

      - name: Push image to ECR (:latest)
        run: |
          set -euxo pipefail
          docker tag custom-wordpress:${IMAGE_TAG} ${ECR_REPO}:${IMAGE_TAG}
          docker push ${ECR_REPO}:${IMAGE_TAG}

      - name: Save current stable -> previous (if stable exists)
        run: |
          set -euo pipefail

          MANIFEST=$(aws ecr batch-get-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-ids imageTag="stable" \
            --region "${AWS_REGION}" \
            --query 'images[0].imageManifest' \
            --output text 2>/dev/null || true)

          if [ -n "$MANIFEST" ] && [ "$MANIFEST" != "None" ]; then
            aws ecr put-image \
              --repository-name "${ECR_REPO_NAME}" \
              --image-tag "previous" \
              --image-manifest "$MANIFEST" \
              --region "${AWS_REGION}"
            echo "Saved stable -> previous"
          else
            echo "No stable tag found yet. Skipping previous."
          fi

      - name: Promote latest -> stable
        run: |
          set -euxo pipefail

          NEW_MANIFEST=$(aws ecr batch-get-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-ids imageTag="latest" \
            --region "${AWS_REGION}" \
            --query 'images[0].imageManifest' \
            --output text)

          aws ecr put-image \
            --repository-name "${ECR_REPO_NAME}" \
            --image-tag "stable" \
            --image-manifest "$NEW_MANIFEST" \
            --region "${AWS_REGION}"

          echo "Promoted latest -> stable"